{% extends 'adminpanel/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
  <div>
    <h1 class="page-title"><i class="fas fa-graduation-cap"></i>{{ program.name }}</h1>
    <p class="page-subtitle">
      {{ program.department.name }} | {{ program.duration_years }} Years ({{ total_semesters }} Semesters)
    </p>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'adminpanel:program_edit' program.pk %}" class="btn btn-outline-primary">
      <i class="fas fa-edit me-2"></i>Edit Program
    </a>
    <a href="{% url 'adminpanel:programs' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back
    </a>
  </div>
</div>

<div class="row">
  <!-- Semester Courses -->
  <div class="col-lg-8">
    <div class="row">
      {% for sem in semester_range %}
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
            <span><i class="fas fa-book-open me-2"></i>Semester {{ sem }}</span>
            <span class="badge bg-light text-primary">{{ semester_courses|get_item:sem|length }} Subjects</span>
          </div>
          <div class="card-body p-0">
            {% with courses=semester_courses|get_item:sem %}
            {% if courses %}
            <ul class="list-group list-group-flush">
              {% for psc in courses %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ psc.course.code }}</strong>
                  <br>
                  <small class="text-muted">{{ psc.course.title|truncatechars:30 }}</small>
                  {% if psc.is_elective %}
                    <span class="badge bg-info ms-1">Elective</span>
                  {% endif %}
                </div>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                          data-bs-toggle="dropdown" title="Move to another semester">
                    <i class="fas fa-arrows-alt"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><span class="dropdown-header">Move to Semester</span></li>
                    {% for s in semester_range %}
                    {% if s != sem %}
                    <li>
                      <form method="post" action="{% url 'adminpanel:program_move_course' program.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="psc_id" value="{{ psc.pk }}">
                        <input type="hidden" name="new_semester" value="{{ s }}">
                        <button type="submit" class="dropdown-item">Semester {{ s }}</button>
                      </form>
                    </li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                  <form method="post" action="{% url 'adminpanel:program_remove_course' program.pk psc.course.pk %}" 
                        class="d-inline" onsubmit="return confirm('Remove this course?')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger" title="Remove">
                      <i class="fas fa-times"></i>
                    </button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="text-center py-3 text-muted">
              <i class="fas fa-inbox mb-2"></i>
              <p class="small mb-0">No subjects added</p>
            </div>
            {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Add Course Sidebar -->
  <div class="col-lg-4">
    <div class="card sticky-top" style="top: 100px;">
      <div class="card-header">
        <i class="fas fa-plus"></i>Add Course to Semester
      </div>
      <div class="card-body">
        {% if available_courses %}
        <form method="post" action="{% url 'adminpanel:program_add_course' program.pk %}">
          {% csrf_token %}
          
          <div class="mb-3">
            <label for="course" class="form-label">Select Course <span class="text-danger">*</span></label>
            <select class="form-select" id="course" name="course" required>
              <option value="">Choose a course...</option>
              {% for course in available_courses %}
                <option value="{{ course.pk }}">{{ course.code }} - {{ course.title }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="semester" class="form-label">Semester <span class="text-danger">*</span></label>
            <select class="form-select" id="semester" name="semester" required>
              {% for sem in semester_range %}
                <option value="{{ sem }}">Semester {{ sem }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="is_elective" name="is_elective">
              <label class="form-check-label" for="is_elective">
                Mark as Elective
              </label>
            </div>
          </div>
          
          <button type="submit" class="btn btn-royal w-100">
            <i class="fas fa-plus me-2"></i>Add Course
          </button>
        </form>
        {% else %}
        <div class="text-center text-muted py-3">
          <i class="fas fa-check-circle fa-2x mb-2"></i>
          <p class="mb-2">All courses have been added</p>
          <a href="{% url 'adminpanel:course_add' %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-plus me-1"></i>Create New Course
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <i class="fas fa-chart-pie"></i>Program Summary
      </div>
      <div class="card-body">
        <table class="table table-sm mb-0">
          <tbody>
            <tr>
              <td>Department</td>
              <td class="text-end"><strong>{{ program.department.name }}</strong></td>
            </tr>
            <tr>
              <td>Duration</td>
              <td class="text-end"><strong>{{ program.duration_years }} Years</strong></td>
            </tr>
            <tr>
              <td>Total Semesters</td>
              <td class="text-end"><strong>{{ total_semesters }}</strong></td>
            </tr>
            <tr>
              <td>Total Subjects</td>
              <td class="text-end">
                <strong>
                  {% with total=program.semester_courses.count %}
                    {{ total }}
                  {% endwith %}
                </strong>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .card-header.bg-primary {
    background: linear-gradient(135deg, var(--royal-red), var(--deep-red)) !important;
  }
</style>
{% endblock %}
