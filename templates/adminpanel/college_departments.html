{% extends "adminpanel/base.html" %}
{% block content %}
<div class="page-header">
  <h1 class="page-title"><i class="fas fa-building"></i>Manage Departments for {{ college.name }}</h1>
  <p class="page-subtitle">Select which departments this college should be affiliated with</p>
</div>

<div class="card">
  <div class="card-body">
    {% if not college.is_approved %}
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      This college is not yet approved. Approve the college first before managing departments.
    </div>
    {% else %}
    <form method="post">
      {% csrf_token %}
      
      <p class="text-muted mb-4">
        Select the departments that this college wishes to offer programs from. 
        After selection, the affiliation request will be sent for university approval.
      </p>
      
      <div class="row g-3">
        {% for dept in departments %}
        <div class="col-md-6 col-lg-4">
          <div class="form-check border rounded p-3 h-100 {% if dept.id in affiliated_dept_ids %}bg-light border-success{% endif %}">
            <input class="form-check-input" type="checkbox" name="departments" value="{{ dept.id }}" id="dept_{{ dept.id }}"
              {% if dept.id in affiliated_dept_ids %}checked{% endif %}>
            <label class="form-check-label w-100" for="dept_{{ dept.id }}">
              <strong>{{ dept.name }}</strong>
              <br><small class="text-muted">{{ dept.code }} &bull; {{ dept.program_set.count }} programs</small>
              <div class="mt-2">
                {% for program in dept.program_set.all|slice:":3" %}
                <span class="badge bg-secondary me-1 mb-1">{{ program.name }}</span>
                {% endfor %}
                {% if dept.program_set.count > 3 %}
                <span class="badge bg-outline-secondary">+{{ dept.program_set.count|add:"-3" }} more</span>
                {% endif %}
              </div>
            </label>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <hr class="my-4">
      
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Current affiliation status: 
          {% if college.affiliation_status == 'not_applied' %}
            <span class="badge bg-secondary">Not Applied</span>
          {% elif college.affiliation_status == 'pending' %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% elif college.affiliation_status == 'approved' %}
            <span class="badge bg-success">Affiliated</span>
          {% else %}
            <span class="badge bg-danger">Rejected</span>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          <a href="{% url 'adminpanel:college_detail' college.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Cancel
          </a>
          <button type="submit" class="btn btn-royal">
            <i class="fas fa-save me-1"></i> Save Departments
          </button>
        </div>
      </div>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}
