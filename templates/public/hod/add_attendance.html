{% extends 'public/hod/base.html' %}

{% block title %}Add Attendance - HOD Portal{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title"><i class="fas fa-plus-circle"></i> Add Attendance Session</h1>
  <p class="page-subtitle">Create a new attendance session for your class</p>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-clipboard-list me-2"></i>Session Details
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-building me-1"></i>Department *</label>
              <select name="department" class="form-select" required id="department-select">
                <option value="">Select Department</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-graduation-cap me-1"></i>Program *</label>
              <select name="program" class="form-select" required id="program-select">
                <option value="">Select Program</option>
                {% for program in programs %}
                <option value="{{ program.id }}" data-dept="{{ program.department_id }}" data-years="{{ program.duration_years }}">{{ program.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-layer-group me-1"></i>Semester *</label>
              <select name="semester" class="form-select" required id="semester-select">
                <option value="">Select Semester</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-book me-1"></i>Subject *</label>
              <select name="subject" class="form-select" required id="subject-select" disabled>
                <option value="">Select Program & Semester first</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-4">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-calendar me-1"></i>Date *</label>
              <input type="date" name="date" class="form-control" value="{{ today }}" required>
            </div>
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-arrow-right me-2"></i>Continue to Mark Attendance
            </button>
            <a href="{% url 'public:hod_attendance' %}" class="btn btn-outline-secondary">
              <i class="fas fa-times me-2"></i>Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-info-circle me-2"></i>Instructions
      </div>
      <div class="card-body">
        <ol class="mb-0">
          <li class="mb-2">Select department and program</li>
          <li class="mb-2">Choose the semester to see available subjects</li>
          <li class="mb-2">Select the subject for attendance</li>
          <li class="mb-2">Click continue to mark individual student attendance</li>
        </ol>
        <hr>
        <p class="text-muted small mb-0">
          <i class="fas fa-lightbulb me-1"></i>
          Subjects are configured per semester in the Admin Panel â†’ Programs section.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const departmentSelect = document.getElementById('department-select');
  const programSelect = document.getElementById('program-select');
  const semesterSelect = document.getElementById('semester-select');
  const subjectSelect = document.getElementById('subject-select');
  
  // Filter programs by department
  departmentSelect.addEventListener('change', function() {
    const deptId = this.value;
    
    // Filter and reset program
    Array.from(programSelect.options).forEach(opt => {
      if (opt.value === '') return;
      opt.style.display = (opt.dataset.dept === deptId || deptId === '') ? '' : 'none';
    });
    programSelect.value = '';
    semesterSelect.innerHTML = '<option value="">Select Semester</option>';
    subjectSelect.innerHTML = '<option value="">Select Program & Semester first</option>';
    subjectSelect.disabled = true;
  });
  
  // Populate semesters based on program duration
  programSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const years = parseInt(selectedOption.dataset.years) || 4;
    const totalSemesters = years * 2;
    
    semesterSelect.innerHTML = '<option value="">Select Semester</option>';
    for (let i = 1; i <= totalSemesters; i++) {
      semesterSelect.innerHTML += `<option value="${i}">Semester ${i}</option>`;
    }
    
    subjectSelect.innerHTML = '<option value="">Select Semester first</option>';
    subjectSelect.disabled = true;
  });
  
  // Fetch subjects when semester is selected
  semesterSelect.addEventListener('change', function() {
    const programId = programSelect.value;
    const semester = this.value;
    
    if (programId && semester) {
      fetch(`{% url 'public:get_semester_subjects' %}?program_id=${programId}&semester=${semester}`)
        .then(response => response.json())
        .then(data => {
          subjectSelect.innerHTML = '<option value="">Select Subject</option>';
          if (data.subjects.length > 0) {
            data.subjects.forEach(subject => {
              subjectSelect.innerHTML += `<option value="${subject.id}">${subject.code} - ${subject.title}</option>`;
            });
            subjectSelect.disabled = false;
          } else {
            subjectSelect.innerHTML = '<option value="">No subjects configured for this semester</option>';
            subjectSelect.disabled = true;
          }
        });
    } else {
      subjectSelect.innerHTML = '<option value="">Select Program & Semester first</option>';
      subjectSelect.disabled = true;
    }
  });
});
</script>
{% endblock %}
